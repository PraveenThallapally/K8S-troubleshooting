name: Deploy to Dev
 
on:
  push:
    branches:
      - main
 
jobs:
  docker-build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: app/src              # ✅ Your Dockerfile location
          file: app/src/Dockerfile      # ✅ Full path to Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/static-web-page:${{ github.sha }}
 
  update-k8s-manifest:
    runs-on: ubuntu-latest
    needs: docker-build-and-push
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.TOKEN }}   # ✅ Your token name
      
      - name: Update image tag in deployment manifest
        run: |
          sed -i "s|image:.*|image: ${{ secrets.DOCKER_USERNAME }}/static-web-page:${{ github.sha }}|g" app/src/k8s/dev/deploy.yaml
      
      - name: Commit and push manifest changes
        run: |
          git config --global user.email "thallapellypraveen55@gmail.com"
          git config --global user.name "Praveen Thallapally"
          git add app/src/deploy.yaml
          git commit -m "[CI]: Update image tag to ${{ github.sha }}"
          git push origin main
          # ✅ Removed force flag
          #


      - name: Trigger stage deployment
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.TOKEN }}
          event-type: deploy-stage
          client-payload: '{"image_tag": "${{ github.sha }}"}'
